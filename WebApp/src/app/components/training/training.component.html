<div class="main__training row m-3">
    <div class="training__maincontainer card col-12 p-0">
        <div class="maincontainer__header card-header py-2">
            <div class="d-flex align-items-baseline mb-2">
                <h5 class="m-0">ALLENAMENTO {{training.type}}</h5>
                <div class="d-flex input-group w-auto ml-auto">
                    <div class="input-group-prepend"><span class="input-group-text">ACTIONS</span></div>
                    <div class="d-flex align-items-center form-control">
                        <div (click)="changeMode(PAGEMODE.READONLY)" class="inverse-image-button" [ngClass]="{'active': pageStatus[PAGES.TRAININGS] == PAGEMODE.READONLY}"  ngbTooltip="Visualizza" placement="left"><img src="assets/icons/actions/visibility.svg" style="width:20px; height:auto;"></div>
                        <div (click)="changeMode(PAGEMODE.WRITE)" class="ml-2 inverse-image-button" [ngClass]="{'active': pageStatus[PAGES.TRAININGS] == PAGEMODE.WRITE}"  ngbTooltip="Modifica" placement="left"><img src="assets/icons/actions/edit.svg" style="width:20px; height:auto;"></div>
                        <div (click)="changeMode(PAGEMODE.STATS)" class="ml-2 inverse-image-button" [ngClass]="{'active': pageStatus[PAGES.TRAININGS] == PAGEMODE.STATS}"  ngbTooltip="Statistiche" placement="left"><img src="assets/icons/actions/graph.svg" style="width:20px; height:auto;"></div>
                        <div (click)="deleteTraining()" class="ml-2 inverse-image-button" ngbTooltip="Elimina" placement="left"><img src="assets/icons/actions/garbage-can.svg" style="width:20px; height:auto;"></div>
                    </div>
                </div>
            </div>
            <h6 class="m-0">
                <span>Atleta {{training.athlete.name}} {{training.athlete.surname}} ({{training.athlete.dateOfBirth | date:'d MMMM yyyy'}} &bull; {{training.athlete.bodyWeight}} kg)</span>
                <span class="m-0">, dal {{training.startDate | date:'d MMMM yyyy'}} al {{training.endDate | date:'d MMMM yyyy'}}</span>
            </h6>
        </div>
        <div class="maincontainer__body card-body p-2">

            <!-- READ ONLY MODE CONTENT -->
            <div class="row m-0" *ngIf="pageStatus[PAGES.TRAININGS] == PAGEMODE.READONLY && !bLoading">
                <div class="card w-100 border-0">
                    <div class="card-header border bg-dark text-white round-5">
                        <h5>ALLENAMENTO {{training.type}} {{training._id}}</h5>
                        <h6 class="m-0">Allenamento creato da {{training.author.name}} {{training.author.surname}} il {{training.creationDate | date:'d MMMM yyyy'}}</h6>
                        <h6 class="m-0">
                            <span>Atleta {{training.athlete.name}} {{training.athlete.surname}} ({{training.athlete.dateOfBirth | date:'d MMMM yyyy'}} &bull; {{training.athlete.bodyWeight}} kg)</span>
                            <span class="m-0">, dal {{training.startDate | date:'d MMMM yyyy'}} al {{training.endDate | date:'d MMMM yyyy'}}</span>
                        </h6>
                        <span [hidden]="(training.comment == null || training.comment == '')">Commento: {{training.comment}}</span>
                    </div>
                    <div class="card-body p-0 ">
                        <div class="card my-3 border-lightdark" *ngFor="let week of training.weeks; index as weekIndex;">
                            <div class="card-header border border-dark bg-dark text-white">
                                <h6 class="m-0">WEEK {{weekIndex+1}}</h6>
                                <span [hidden]="(week.comment == null || week.comment == '')">Commento: {{week.comment}}</span>
                            </div>
                            <div class="card-body border-0 p-0 ">
                                <div *ngFor="let session of week.sessions; index as sessionIndex" class="card border-0 round-0" style="box-shadow: 0px 2px 0px rgba(0,0,0,.5);">
                                    <div class="card-header m-0 px-0 bg-lightdark border-0 round-0 text-white">
                                        <h6 class="m-0 px-3">Sessione {{session.name}} - {{session.name}}</h6>
                                        <div class="sub-header row m-0 px-3 py-0">
                                            <div class="col-4 px-0">
                                                <span>Esercizio (variante)</span>
                                            </div>
                                            <div class="col-8 pr-0">
                                                <div class="row m-0 d-flex">
                                                    <span>Serie &times; Ripetizioni</span>
                                                    <span class="ml-auto">Riposo</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-0">
                                        <div *ngFor="let exercise of session.exercises; index as exerciseIndex" class="row m-0 px-3 py-1 border border-left-0 border-right-0 border-top-0">
                                            <div class="col-4 px-0">
                                                <div><span>{{exercise.name}} ({{exercise.variant.name}})</span></div>
                                                <div><span>{{exercise.description}}</span></div>
                                            </div>
                                            <div class="col-8 pr-0">
                                                <div *ngFor="let series of exercise.series; index as seriesIndex" class="row m-0 d-flex">
                                                    <span>{{series.seriesNumber}} &times; {{series.repNumber}} @ {{series.weight}} {{series.measure}}</span>
                                                    <span class="ml-auto">{{series.rest}}''</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-footer border-0 bg-white px-3">
                                        <span>{{(session.comment == null || session.comment == '') ? 'Nessun commento' : ('Commento: ' + session.comment)}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                
                
                <!-- <editor apiKey="nezikf86u3tkn42uasu6wth68lb9qcfa2dszno3h7anr94qq" initialValue={{editorContent}}
                [init]="{
                    plugins: [
                    'advlist autolink lists link image charmap print preview anchor',
                    'searchreplace visualblocks code fullscreen',
                    'insertdatetime media table paste code help wordcount'
                    ],
                    toolbar:
                    'undo redo | formatselect | bold italic backcolor | \
                    alignleft aligncenter alignright alignjustify | \
                    bullist numlist outdent indent | removeformat | help',
                    content_css: 'assets/libraries/css/bootstrap.css'
                }" 
                ></editor> -->
            </div>

            <!-- WRITE MODE CONTENT -->
            <form class="d-flex" *ngIf="pageStatus[PAGES.TRAININGS] == PAGEMODE.WRITE && !bLoading">
                <!-- WEEKS -->
                <ul ngbNav #nav="ngbNav" [(activeId)]="activeWeek" class="nav-pills mt-2 mr-2 nav flex-column border border-left-0 border-top-0 border-bottom-0" orientation="vertical">
                    <li ngbNavItem="0">
                        <a ngbNavLink class="d-flex">INFO&nbsp;<img [hidden]="activeWeek != 0" src="assets/icons/actions/info-light.svg" style="width:15px; height:auto;"><img [hidden]="activeWeek == 0" src="assets/icons/actions/info-dark.svg" style="width:15px; height:auto;"></a>
                        <ng-template ngbNavContent class="w-100">
                            <div class="form-row m-0">
                                <div class="col-12 form-group">Allenamento creato da {{training.author.name}} {{training.author.surname}} il {{training.creationDate | date:'d MMMM yyyy'}}</div>
                                <div class="col-4 form-group">
                                    <label for="trainingType" class="col-form-label col-form-label-sm text-muted">Disciplina</label>
                                    <select [(ngModel)]="training.type" class="form-control form-control-sm cursor-pointer" id="trainingType" name="trainingType">
                                        <option [value]="'POWERLIFTING'">POWERLIFTING</option>
                                        <option [value]="'WEIGHTLIFTING'">WEIGHTLIFTING</option>
                                        <option [value]="'CROSSFIT'">CROSSFIT</option>
                                        <option [value]="'BODYBUILDING'">BODYBUILDING</option>
                                        <option [value]="'SALA ATTREZZI'">SALA ATTREZZI</option>
                                    </select>
                                </div>
                                <div class="col-4 form-group">
                                    <label for="trainingAthlete" class="col-form-label col-form-label-sm text-muted">Atleta</label>
                                    <select [(ngModel)]="training.athlete" class="form-control form-control-sm cursor-pointer" id="trainingAthlete" name="trainingAthlete" [compareWith]="compareObjects">
                                        <option [ngValue]="athlete" *ngFor="let athlete of athleteList; index as athleteIndex">{{athlete.name}} {{athlete.surname}}</option>
                                    </select>
                                </div>
                                <div class="col-2 form-group">
                                    <label for="trainingStartDate" class="col-form-label col-form-label-sm text-muted">Data inizio</label>
                                    <input type="date"  [ngModel] ="training.startDate | date:'yyyy-MM-dd'" (ngModelChange)="training.startDate = $event" class="form-control form-control-sm"
                                        id="trainingStartDate" name="trainingStartDate">
                                </div>
                                <div class="col-2 form-group">
                                    <label for="trainingEndDate" class="col-form-label col-form-label-sm text-muted">Data fine</label>
                                    <input type="date" [ngModel] ="training.endDate | date:'yyyy-MM-dd'" (ngModelChange)="training.endDate = $event" class="form-control form-control-sm"
                                        id="trainingEndDate" name="trainingEndDate">
                                </div>
                                <div class="col-12 form-group">
                                    <label for="trainingcomment" class="col-form-label col-form-label-sm text-muted">Commento</label>
                                    <textarea [(ngModel)]="training.comment" class="form-control form-control-sm"
                                        id="trainingcomment" name="trainingcomment" placeholder="Commento..."></textarea>
                                </div>
                            </div>
                        </ng-template>  
                    </li>
                    <li *ngFor="let week of training.weeks; index as weekIndex; first as weekFirst" [ngbNavItem]="weekIndex+1">
                        <a ngbNavLink class="d-flex">
                            <span>WEEK&nbsp;{{weekIndex+1}}</span>
                            <span class="ml-2 image-button" ngbTooltip="Copia settimana" placement="top" (click)="copyWeek($event, weekIndex)"><img [hidden]="activeWeek != weekIndex+1" src="assets/icons/actions/copy-light.svg" style="width:15px; height:auto;"><img [hidden]="activeWeek == weekIndex+1" src="assets/icons/actions/copy.svg" style="width:15px; height:auto;"></span>
                            <span class="ml-1 image-button" ngbTooltip="Incolla settimana" placement="top" (click)="pasteWeek($event, weekIndex)"><img [hidden]="activeWeek != weekIndex+1" src="assets/icons/actions/contract-light.svg" style="width:15px; height:auto;"><img [hidden]="activeWeek == weekIndex+1" src="assets/icons/actions/contract.svg" style="width:15px; height:auto;"></span>
                            <span class="ml-1 image-button" ngbTooltip="Reset settimana" placement="top" (click)="resetWeek($event, weekIndex)"><img [hidden]="activeWeek != weekIndex+1" src="assets/icons/actions/return-light.svg" style="width:15px; height:auto;"><img [hidden]="activeWeek == weekIndex+1" src="assets/icons/actions/return.svg" style="width:15px; height:auto;"></span>
                            <span class="ml-1 image-button" ngbTooltip="Elimina settimana" placement="top" (click)="deleteWeek($event, weekIndex)" [hidden]="training.weeks.length == 1"><img [hidden]="activeWeek != weekIndex+1" src="assets/icons/actions/garbage-can-light.svg" style="width:15px; height:auto;"><img [hidden]="activeWeek == weekIndex+1" src="assets/icons/actions/garbage-can.svg" style="width:15px; height:auto;"></span>
                        </a>
                        <ng-template ngbNavContent>
                        
                            <!-- SESSIONS -->
                            <ul ngbNav #nav="ngbNav" [(activeId)]="activeSession[weekIndex]" class="nav-tabs">
                                <li [ngbNavItem]="0">
                                    <a ngbNavLink class="d-flex">INFO&nbsp;<img src="assets/icons/actions/info-dark.svg" style="width:15px; height:auto;"></a>
                                    <ng-template ngbNavContent>
                                        <div class="form-row m-0">
                                            <div class="col-12 form-group pl-3">
                                                <label for="weekcomment_{{weekIndex}}" class="col-form-label col-form-label-sm text-muted">Commento</label>
                                                <textarea [(ngModel)]="week.comment" class="form-control form-control-sm"
                                                    id="weekcomment_{{weekIndex}}" name="weekcomment_{{weekIndex}}" placeholder="Commento..."></textarea>
                                            </div>
                                        </div>
                                    </ng-template>
                                </li>
                                <li *ngFor="let session of week.sessions; index as sessionIndex; first as sessionFirst" [ngbNavItem]="sessionIndex+1">
                                    <a ngbNavLink class="d-flex align-items-baseline">
                                        <span>Sessione {{sessionIndex+1}}</span>
                                        <span class="ml-2 image-button" ngbTooltip="Copia Sessione" placement="top" (click)="copySession($event, week, sessionIndex)"><img src="assets/icons/actions/copy.svg" style="width:15px; height:auto;"></span>
                                        <span class="ml-1 image-button" ngbTooltip="Incolla Sessione" placement="top" (click)="pasteSession($event, week, sessionIndex)"><img src="assets/icons/actions/contract.svg" style="width:15px; height:auto;"></span>
                                        <span class="ml-1 image-button" ngbTooltip="Reset Sessione" placement="top" (click)="resetSession($event, week, sessionIndex, weekIndex)"><img src="assets/icons/actions/return.svg" style="width:15px; height:auto;"></span>
                                        <span class="ml-1 image-button" ngbTooltip="Elimina Sessione" placement="top" (click)="deleteSession($event, week, sessionIndex, weekIndex)" [hidden]="week.sessions.length == 1"><img src="assets/icons/actions/garbage-can.svg" style="width:15px; height:auto;"></span>
                                    </a>
                                    <ng-template ngbNavContent>
                                        <div class="form-row m-0">
                                            <div class="col-2 form-group pl-0">
                                                <label for="trainingName_{{weekIndex}}" class="col-form-label col-form-label-sm text-muted">Nome sessione</label>
                                                <input type="text" [(ngModel)]="session.name" class="form-control form-control-sm"
                                                    id="trainingName_{{weekIndex}}" name="trainingName_{{weekIndex}}" placeholder="Nome sessione...">
                                            </div>
                                            <div class="col-10 form-group pr-0">
                                                <label for="trainingComment_{{weekIndex}}" class="col-form-label col-form-label-sm text-muted">Commento</label>
                                                <input type="text" [(ngModel)]="session.comment" class="form-control form-control-sm"
                                                    id="trainingComment_{{weekIndex}}" name="trainingComment_{{weekIndex}}" placeholder="Commento...">
                                            </div>
                                        </div>
                                        <div class="form-row m-0 position-relative border" *ngFor="let exercise of session.exercises; index as exerciseIndex; first as outFirst">
                                            <div class="col-4 d-flex m-0 px-3">
                                                <div class="row m-0">
                                                    <div class="col-6 form-group pl-0 pr-1 m-0">
                                                        <label for="exercise_{{exerciseIndex}}" class="col-form-label col-form-label-sm text-muted">Esercizio</label>
                                                        <input id="exercise_{{exerciseIndex}}" name="exercise_{{exerciseIndex}}" type="text" class="form-control"
                                                            [(ngModel)]="exercise.name"
                                                            [ngbTypeahead]="search"
                                                            [resultTemplate]="rt"
                                                            [editable]='false'
                                                            (selectItem)="selectExercise($event, session.exercises, exerciseIndex)">
                                                            
                                                            <ng-template #rt let-r="result" let-t="term">
                                                                <ngb-highlight [result]="r.name + ' (' + r.variant.name + ')'" [term]="t"></ngb-highlight>
                                                            </ng-template>
                                                    </div>
                                                    <div class="col-6 form-group pl-1 pr-0 m-0">
                                                        <label for="tipo_{{exerciseIndex}}" class="col-form-label col-form-label-sm text-muted">Tipo</label>
                                                        <input type="text" [(ngModel)]="exercise.variant.name" class="form-control form-control-sm"
                                                            id="tipo_{{exerciseIndex}}" name="tipo_{{exerciseIndex}}" placeholder="Tipo esercizio..." disabled>
                                                    </div>
                                                    <div class="col-12 form-group pl-0 pr-0">
                                                        <label for="description_{{exerciseIndex}}" class="col-form-label col-form-label-sm text-muted">Descrizione</label>
                                                        <input type="text" [(ngModel)]="exercise.description" class="form-control form-control-sm"
                                                            id="description_{{exerciseIndex}}" name="description_{{exerciseIndex}}" placeholder="Descrizione esercizio..." disabled>
                                                    </div>
                                                </div>
                                                <div class="pl-3 pr-0 d-flex flex-column align-items-center mt-1">
                                                    <span style="font-size: 0.875rem;">Azioni</span>
                                                    <div class="image-button" ngbTooltip="Copia esercizio" placement="top" (click)="copyExercise(session, exerciseIndex)"><img src="assets/icons/actions/copy.svg" style="width:15px; height:auto;"></div>
                                                    <div class="ml-1 image-button" ngbTooltip="Incolla esercizio" placement="top" (click)="pasteExercise(session, exerciseIndex)"><img src="assets/icons/actions/contract.svg" style="width:15px; height:auto;"></div>
                                                    <div class="ml-1 image-button" ngbTooltip="Reset esercizio" placement="top" (click)="resetExercise(session, exerciseIndex)"><img src="assets/icons/actions/return.svg" style="width:15px; height:auto;"></div>
                                                    <div class="ml-1 image-button" ngbTooltip="Elimina esercizio" placement="top" (click)="deleteExercise(session, exerciseIndex)" [hidden]="session.exercises.length == 1"><img src="assets/icons/actions/garbage-can.svg" style="width:15px; height:auto;"></div>
                                                </div>
                                            </div>
                                            <div class="col-8 pr-3 pl-3 border border-right-0 border-top-0 border-bottom-0">
                                                <div class="form-row m-0" *ngFor="let elem of exercise.series; first as seriesFirst; last as seriesLast; index as seriesIndex">
                                                    <div class="col-2 form-group">
                                                        <label for="serie_{{exerciseIndex}}_{{seriesIndex}}" class="col-form-label col-form-label-sm"
                                                            [hidden]="!seriesFirst">Serie</label>
                                                        <input type="number" min="1" [(ngModel)]="elem.seriesNumber"
                                                            class="form-control form-control-sm" id="serie_{{exerciseIndex}}_{{seriesIndex}}"
                                                            name="serie_{{exerciseIndex}}_{{seriesIndex}}" placeholder="Serie...">
                                                    </div>
                                                    <div class="col-2 form-group">
                                                        <label for="rep_{{exerciseIndex}}_{{seriesIndex}}" class="col-form-label col-form-label-sm"
                                                            [hidden]="!seriesFirst">Rep</label>
                                                        <input type="number" min="1" [(ngModel)]="elem.repNumber"
                                                            class="form-control form-control-sm" id="rep_{{exerciseIndex}}_{{seriesIndex}}"
                                                            name="rep_{{exerciseIndex}}_{{seriesIndex}}" placeholder="Rep...">
                                                    </div>
                                                    <div class="col-2 form-group">
                                                        <label for="peso_{{exerciseIndex}}_{{seriesIndex}}" class="col-form-label col-form-label-sm"
                                                            [hidden]="!seriesFirst">Peso</label>
                                                        <input type="number" min="0" [(ngModel)]="elem.weight"
                                                            class="form-control form-control-sm" id="peso_{{exerciseIndex}}_{{seriesIndex}}"
                                                            name="peso_{{exerciseIndex}}_{{seriesIndex}}" placeholder="Peso...">
                                                    </div>
                                                    <div class="col-2 form-group">
                                                        <label for="misura_{{exerciseIndex}}_{{seriesIndex}}" class="col-form-label col-form-label-sm"
                                                            [hidden]="!seriesFirst">Misura</label>
                                                        <select [(ngModel)]="elem.measure" class="form-control form-control-sm"
                                                            id="misuraSelect_{{exerciseIndex}}_{{seriesIndex}}"
                                                            name="misuraSelect_{{exerciseIndex}}_{{seriesIndex}}">
                                                            <option [value]="'kg'">kg</option>
                                                            <option [value]="'lbs'">lbs</option>
                                                            <option [value]="'%'">% RM</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-2 form-group">
                                                        <label for="rest_{{exerciseIndex}}_{{seriesIndex}}" class="col-form-label col-form-label-sm"
                                                            [hidden]="!seriesFirst">Recupero</label>
                                                        <input type="number" min="0" [(ngModel)]="elem.rest" 
                                                            class="form-control form-control-sm" id="rest_{{exerciseIndex}}_{{seriesIndex}}" 
                                                            name="rest_{{exerciseIndex}}_{{seriesIndex}}">
                                                    </div>
                                                    <div class="col-2 form-group m-0 p-0 pl-2">
                                                        <label class="col-form-label col-form-label-sm" [hidden]="!seriesFirst">Azioni</label>
                                                        <div class="d-flex">
                                                            <div class="image-button" ngbTooltip="Copia" placement="top" (click)="copySeries(exercise, seriesIndex)"><img src="assets/icons/actions/copy.svg" style="width:15px; height:auto;"></div>
                                                            <div class="ml-1 image-button" ngbTooltip="Incolla" placement="top" (click)="pasteSeries(exercise, seriesIndex)"><img src="assets/icons/actions/contract.svg" style="width:15px; height:auto;"></div>
                                                            <div class="ml-1 image-button" ngbTooltip="Reset" placement="top" (click)="resetSeries(exercise, seriesIndex)"><img src="assets/icons/actions/return.svg" style="width:15px; height:auto;"></div>
                                                            <div class="ml-1 image-button" ngbTooltip="Elimina" placement="top" (click)="deleteSeries(exercise, seriesIndex)" [hidden]="exercise.series.length == 1"><img src="assets/icons/actions/garbage-can.svg" style="width:15px; height:auto;"></div>
                                                            <div class="ml-1 image-button" ngbTooltip="Aggiungi" placement="top" (click)="pushSeries(exercise)" [hidden]="!seriesLast"><img src="assets/icons/actions/plus2.svg" style="width:15px; height:auto;"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-row m-0 d-flex justify-content-start">
                                            <div class="btn btn-outline-info btn-small mt-2" (click)="pushExercise(session)">Aggiungi esercizio +</div>
                                        </div>
                                    </ng-template>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href (click)="pushSession($event, week)">Aggiungi <img src="assets/icons/actions/plus.svg" style="width:15px; height:auto;"></a>
                                </li>
                            </ul>
                            <div [ngbNavOutlet]="nav" class="mt-2 session-tab"></div>
                        </ng-template>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex" href (click)="pushWeek($event)">Aggiungi&nbsp;<img src="assets/icons/actions/plus.svg" style="width:15px; height:auto;"></a>
                    </li>
                </ul>
                <div [ngbNavOutlet]="nav" class="mt-2 week-tab w-100"></div>
                <button type="submit" (click)="saveTraining()" class="bottom-right-absolute btn btn-success">SALVA</button>
            </form>

            <!-- STATS MODE CONTENT -->
            <div *ngIf="pageStatus[PAGES.TRAININGS] == PAGEMODE.STATS && !bLoading">
                <training-line-chart [currentTraining]="training"></training-line-chart>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <div class='h-100 w-100' [hidden]="!bLoading">
        <div style="position:absolute; background-color:black; opacity:50%; right:0; top:0;" class="w-100 h-100">
            <div class="container d-flex align-items-center justify-content-center w-100 h-100">
                <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
            </div>
        </div>
    </div>

    <app-exercise-modal [hidden]="true" (onClose)="createExercise()" (onAbort)="abortCreateExercise()" [(newExercise)]="newExercise" style="position: absolute; right: 15px; bottom: 15px">
        <button id="exerciseModalButton" class="image-button cursor-pointer" ngbTooltip="Nuovo" placement="top"><img src="assets/icons/actions/plus.svg" style="width:40px; height:auto;"></button>
    </app-exercise-modal>
</div>